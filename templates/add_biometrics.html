{% extends 'base.html' %}

{% block title %}Add Biometrics - SecureBlink{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0 text-center">Setup Biometric Security</h3>
            </div>
            <div class="card-body">
                <div class="text-center mb-4">
                    <div class="feature-icon mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                        <i class="fas fa-fingerprint"></i>
                    </div>
                    <h4>Enhance Your Security</h4>
                    <p class="text-muted">Set up multiple biometric verification methods to protect your files</p>
                </div>

                <!-- Step Indicator -->
                <div class="step-indicator mb-4">
                    <div class="step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Fingerprint</div>
                        <div class="step-connector"></div>
                    </div>
                    <div class="step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Eye Blink</div>
                        <div class="step-connector"></div>
                    </div>
                    <div class="step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Neck Movement</div>
                        <div class="step-connector"></div>
                    </div>
                    <div class="step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Voice Recognition</div>
                        <div class="step-connector"></div>
                    </div>
                    <div class="step" id="step5">
                        <div class="step-circle">5</div>
                        <div class="step-label">Face Detection</div>
                    </div>
                </div>

                <form id="biometricForm" method="POST" action="{{ url_for('add_biometrics') }}" class="mt-4">
                    <div class="row justify-content-center">
                        <div class="col-md-6 text-center">
                            <div class="card h-100 p-3 mb-3">
                                <!-- This will change dynamically -->
                                <div id="currentBiometric">
                                    <i class="fas fa-fingerprint fa-3x mb-3" style="color: var(--primary);"></i>
                                    <h5>Fingerprint</h5>
                                    <p class="small text-muted">Scan your fingerprint for secure access</p>
                                </div>
                                
                                <div id="captureBox" class="mx-auto mt-4 mb-3" style="width: 100%; height: 400px; border: 3px solid var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; background-color: #1e1e1e;">
                                    <div id="captureIcon">
                                        <i class="fas fa-fingerprint fa-4x" style="color: var(--primary);"></i>
                                    </div>
                                </div>
                                
                                <button type="button" id="captureBtn" class="btn btn-primary">
                                    <i class="fas fa-camera me-2"></i>Start Recording All Biometrics
                                </button>

                                <div id="progressInfo" class="mt-3 text-muted" style="display: none;">
                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span id="currentStepInfo">Recording fingerprint...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" name="fingerprint" id="fingerprintData">
                    <input type="hidden" name="eyeblink" id="eyeblinkData">
                    <input type="hidden" name="neck_movement" id="neckMovementData">
                    <input type="hidden" name="voice" id="voiceData">
                    <input type="hidden" name="face_detection" id="faceDetectionData">

                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="saveBtn" disabled>
                            <i class="fas fa-save me-2"></i>Complete Setup
                        </button>
                        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const captureBtn = document.getElementById('captureBtn');
    const saveBtn = document.getElementById('saveBtn');
    const captureBox = document.getElementById('captureBox');
    const progressInfo = document.getElementById('progressInfo');
    const currentStepInfo = document.getElementById('currentStepInfo');
    const currentBiometric = document.getElementById('currentBiometric');
    
    // Fields to store biometric data
    const fingerprintData = document.getElementById('fingerprintData');
    const eyeblinkData = document.getElementById('eyeblinkData');
    const neckMovementData = document.getElementById('neckMovementData');
    const voiceData = document.getElementById('voiceData');
    const faceDetectionData = document.getElementById('faceDetectionData');

    // Step elements
    const steps = [
        document.getElementById('step1'),
        document.getElementById('step2'),
        document.getElementById('step3'),
        document.getElementById('step4'),
        document.getElementById('step5')
    ];

    // Biometric icons and content
    const biometricContent = [
        {
            icon: 'fa-fingerprint',
            title: 'Fingerprint',
            desc: 'Scan your fingerprint for secure access'
        },
        {
            icon: 'fa-eye',
            title: 'Eye Blink',
            desc: 'Verify with your unique eye blink pattern'
        },
        {
            icon: 'fa-head-side-mask',
            title: 'Neck Movement',
            desc: 'Use neck gestures for verification'
        },
        {
            icon: 'fa-microphone',
            title: 'Voice Recognition',
            desc: 'Verify with your unique voice pattern'
        },
        {
            icon: 'fa-user',
            title: 'Face Detection',
            desc: 'Use facial recognition for verification'
        }
    ];

    function updateStep(stepIndex) {
        // Update step indicators
        for (let i = 0; i < steps.length; i++) {
            if (i < stepIndex) {
                steps[i].classList.add('complete');
                steps[i].classList.remove('active');
            } else if (i === stepIndex) {
                steps[i].classList.add('active');
                steps[i].classList.remove('complete');
            } else {
                steps[i].classList.remove('active', 'complete');
            }
        }

        // Update current biometric content
        if (stepIndex < biometricContent.length) {
            const content = biometricContent[stepIndex];
            currentBiometric.innerHTML = `
                <i class="fas ${content.icon} fa-3x mb-3" style="color: var(--primary);"></i>
                <h5>${content.title}</h5>
                <p class="small text-muted">${content.desc}</p>
            `;

            // Update capture box icon
            captureBox.innerHTML = `
                <div id="captureIcon">
                    <i class="fas ${content.icon} fa-4x" style="color: var(--primary);"></i>
                </div>
            `;

            // Update step info text
            currentStepInfo.textContent = `Recording ${content.title.toLowerCase()}...`;
        }
    }

    async function handleFingerprintCapture() {
        const captureBox = document.getElementById('captureBox');
        const fingerprintData = document.getElementById('fingerprintData');
        
        // Return a Promise to ensure we wait for completion
        return new Promise((resolve, reject) => {
            // Show the fingerprint count selection UI
            captureBox.innerHTML = `
                <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                    <i class="fas fa-fingerprint fa-4x mb-3" style="color: var(--primary);"></i>
                    <h4 class="mb-3" style="color: black;">Fingerprint Sequence Setup</h4>
                    <p style="color: #555;">How many fingerprints would you like to enroll in sequence? (1-5)</p>
                    
                    <div class="mb-3 mt-4">
                        <div class="d-flex align-items-center justify-content-center">
                            <span class="me-3" style="font-size: 1.2rem; font-weight: bold;">1</span>
                            <input type="range" class="form-range" min="1" max="5" value="1" id="fingerprintCountSlider" style="width: 200px;">
                            <span class="ms-3" style="font-size: 1.2rem; font-weight: bold;">5</span>
                        </div>
                        <div class="mt-2">
                            <span id="selectedCount" style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">1</span> fingerprint(s)
                        </div>
                    </div>
                    
                    <button id="startFingerprintEnrollmentBtn" class="btn btn-primary mt-3">
                        <i class="fas fa-arrow-right me-2"></i>Begin Enrollment
                    </button>
                </div>
            `;
            
            // Update the selected count when slider changes
            const slider = document.getElementById('fingerprintCountSlider');
            const selectedCountSpan = document.getElementById('selectedCount');
            
            slider.addEventListener('input', function() {
                selectedCountSpan.textContent = this.value;
            });
            
            // Set up the enrollment process
            document.getElementById('startFingerprintEnrollmentBtn').addEventListener('click', async function() {
                const totalPrints = parseInt(slider.value);
                let currentSequence = 1;
                
                // Function to handle each fingerprint in sequence
                async function captureFingerprint(sequenceNumber) {
                    return new Promise((resolveCapture, rejectCapture) => {
                        captureBox.innerHTML = `
                            <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <i class="fas fa-fingerprint fa-4x mb-3" style="color: var(--primary);"></i>
                                <div class="progress mb-3" style="height: 10px;">
                                    <div class="progress-bar" role="progressbar" style="width: ${(sequenceNumber-1)/totalPrints*100}%" aria-valuenow="${sequenceNumber-1}" aria-valuemin="0" aria-valuemax="${totalPrints}"></div>
                                </div>
                                <h4 class="mb-3" style="color: black;">Upload Fingerprint #${sequenceNumber} of ${totalPrints}</h4>
                                <p style="color: #555;">Please upload a clear image of your fingerprint</p>
                                
                                <div class="mb-3 mt-4">
                                    <input type="file" id="fingerprintFileInput" class="form-control" accept="image/*">
                                </div>
                                
                                <button id="uploadFingerprintBtn" class="btn btn-primary mt-2">
                                    <i class="fas fa-upload me-2"></i>Upload Fingerprint #${sequenceNumber}
                                </button>
                            </div>
                        `;
                        
                        document.getElementById('uploadFingerprintBtn').addEventListener('click', async function() {
                            const fileInput = document.getElementById('fingerprintFileInput');
                            
                            if (!fileInput.files || fileInput.files.length === 0) {
                                alert('Please select a fingerprint image to upload');
                                return;
                            }
                            
                            captureBox.innerHTML = `
                                <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                                    <h4 class="mb-3" style="color: black;">Uploading Fingerprint #${sequenceNumber}</h4>
                                    <p style="color: #555;">Please wait while we process your fingerprint image...</p>
                                </div>
                            `;
                            
                            const formData = new FormData();
                            formData.append('fingerprint_image', fileInput.files[0]);
                            formData.append('biometric_type', 'fingerprint');
                            formData.append('sequence_number', sequenceNumber);
                            formData.append('total_prints', totalPrints);
                            
                            try {
                                const response = await fetch('/record_biometric', {
                                    method: 'POST',
                                    body: formData
                                });
                                
                                const result = await response.json();
                                
                                if (result.success) {
                                    if (sequenceNumber === totalPrints) {
                                        fingerprintData.value = result.code;
                                    }
                                    
                                    captureBox.innerHTML = `
                                        <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #28a745; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                                                <i class="fas fa-check fa-3x" style="color: white;"></i>
                                            </div>
                                            <h4 style="color: black;">Fingerprint #${sequenceNumber} Saved Successfully</h4>
                                            <p style="color: #555; max-width: 80%; margin: 15px auto;">Your fingerprint has been saved.</p>
                                            <div class="progress mb-3 mt-2" style="height: 10px; width: 80%;">
                                                <div class="progress-bar" role="progressbar" style="width: ${sequenceNumber/totalPrints*100}%" aria-valuenow="${sequenceNumber}" aria-valuemin="0" aria-valuemax="${totalPrints}"></div>
                                            </div>
                                            <p style="color: #555;">Progress: ${sequenceNumber} of ${totalPrints} fingerprints</p>
                                            <div class="d-flex mt-3">
                                                <button id="retakeBtn" class="btn btn-outline-secondary me-2">
                                                    <i class="fas fa-redo me-2"></i>Retry This Fingerprint
                                                </button>
                                                <button id="continueBtn" class="btn btn-primary">
                                                    <i class="fas fa-arrow-right me-2"></i>${sequenceNumber === totalPrints ? 'Complete Enrollment' : 'Next Fingerprint'}
                                                </button>
                                            </div>
                                        </div>`;
                                    
                                    document.getElementById('retakeBtn').addEventListener('click', function() {
                                        captureFingerprint(sequenceNumber).then(resolveCapture).catch(rejectCapture);
                                    });
                                    
                                    document.getElementById('continueBtn').addEventListener('click', function() {
                                        resolveCapture(result.code);
                                    });
                                } else {
                                    captureBox.innerHTML = `
                                        <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                            <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #dc3545; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                                                <i class="fas fa-times fa-3x" style="color: white;"></i>
                                            </div>
                                            <h4 style="color: black;">Fingerprint Upload Failed</h4>
                                            <p style="color: #555; max-width: 80%; margin: 15px auto;">${result.error || "An unexpected error occurred"}</p>
                                            <button id="retryBtn" class="btn btn-primary mt-3">Try Again</button>
                                        </div>`;
                                    
                                    document.getElementById('retryBtn').addEventListener('click', function() {
                                        captureFingerprint(sequenceNumber).then(resolveCapture).catch(rejectCapture);
                                    });
                                }
                            } catch (error) {
                                console.error('Fingerprint upload error:', error);
                                
                                captureBox.innerHTML = `
                                    <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                        <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #dc3545; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                                            <i class="fas fa-times fa-3x" style="color: white;"></i>
                                        </div>
                                        <h4 style="color: black;">Upload Error</h4>
                                        <p style="color: #555; max-width: 80%; margin: 15px auto;">${error.message || "An unexpected error occurred"}</p>
                                        <button id="retryBtn" class="btn btn-primary mt-3">Try Again</button>
                                    </div>`;
                                
                                document.getElementById('retryBtn').addEventListener('click', function() {
                                    captureFingerprint(sequenceNumber).then(resolveCapture).catch(rejectCapture);
                                });
                            }
                        });
                    });
                }
                
                try {
                    for (let seq = 1; seq <= totalPrints; seq++) {
                        await captureFingerprint(seq);
                    }
                    
                    captureBox.innerHTML = `
                        <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #28a745; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                                <i class="fas fa-check fa-3x" style="color: white;"></i>
                            </div>
                            <h4 style="color: black;">Fingerprint Enrollment Complete!</h4>
                            <p style="color: #555; max-width: 80%; margin: 15px auto;">All ${totalPrints} fingerprints have been successfully enrolled.</p>
                            <button id="finalContinueBtn" class="btn btn-success mt-3">
                                <i class="fas fa-arrow-right me-2"></i>Continue to Next Biometric
                            </button>
                        </div>`;
                    
                    document.getElementById('finalContinueBtn').addEventListener('click', function() {
                        resolve();
                    });
                    
                } catch (error) {
                    console.error('Error in fingerprint sequence enrollment:', error);
                    captureBox.innerHTML = `
                        <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #dc3545; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                                <i class="fas fa-times fa-3x" style="color: white;"></i>
                            </div>
                            <h4 style="color: black;">Enrollment Process Failed</h4>
                            <p style="color: #555; max-width: 80%; margin: 15px auto;">${error.message || "An unexpected error occurred"}</p>
                            <button id="restartBtn" class="btn btn-primary mt-3">Restart Enrollment</button>
                        </div>`;
                    
                    document.getElementById('restartBtn').addEventListener('click', function() {
                        handleFingerprintCapture().then(resolve).catch(reject);
                    });
                }
            });
        });
    }

    captureBtn.addEventListener('click', async function() {
        captureBtn.disabled = true;
        progressInfo.style.display = 'block';
        
        try {
            updateStep(0);
            currentStepInfo.textContent = 'Recording fingerprint...';
            
            await handleFingerprintCapture();
            
            updateStep(1);
            currentStepInfo.textContent = 'Recording eye blink pattern...';

            captureBox.innerHTML = `
                <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                    <h4 class="mb-3" style="color: black;">Recording Eye Blink Pattern</h4>
                    <p style="color: black;">A camera window has opened. Please look at the camera and blink your eyes to record a pattern.</p>
                    <p style="color: #555;">The window will close automatically when recording is complete.</p>
                </div>
            `;

            const eyeblinkResponse = await fetch('/record_biometric', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    biometric_type: 'eyeblink'
                })
            });

            const eyeblinkResult = await eyeblinkResponse.json();

            if (eyeblinkResult.success) {
                eyeblinkData.value = eyeblinkResult.code;
                captureBox.innerHTML = `
                    <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <i class="fas fa-check-circle fa-4x" style="color: var(--success); margin-bottom: 15px;"></i>
                        <h4 style="color: black;">Eye blink pattern recorded!</h4>
                        
                        <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 90%;">
                            <h5 style="color: black;">Your pattern:</h5>
                            <div class="d-flex align-items-center justify-content-center">
                                <span class="badge bg-primary p-2 mx-1" style="font-size: 1.1rem;">Code: ${eyeblinkResult.code}</span>
                            </div>
                            <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">${eyeblinkResult.display}</p>
                        </div>
                        
                        <div class="d-flex mt-3">
                            <button id="eyeblinkRetakeBtn" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-redo me-2"></i>Retake
                            </button>
                            <button id="eyeblinkContinueBtn" class="btn btn-primary">
                                <i class="fas fa-arrow-right me-2"></i>Continue
                            </button>
                        </div>
                    </div>`;
                
                const retakeBtn = document.getElementById('eyeblinkRetakeBtn');
                const continueBtn = document.getElementById('eyeblinkContinueBtn');
                
                await new Promise(resolve => {
                    retakeBtn.addEventListener('click', async () => {
                        captureBox.innerHTML = `
                            <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                                <h4 class="mb-3" style="color: black;">Recording Eye Blink Pattern</h4>
                                <p style="color: black;">A camera window has opened. Please look at the camera and blink your eyes to record a pattern.</p>
                                <p style="color: #555;">The window will close automatically when recording is complete.</p>
                            </div>
                        `;
                        
                        const newResponse = await fetch('/record_biometric', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                biometric_type: 'eyeblink'
                            })
                        });
                        
                        const newResult = await newResponse.json();
                        
                        if (newResult.success) {
                            eyeblinkData.value = newResult.code;
                            captureBox.innerHTML = `
                                <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                    <i class="fas fa-check-circle fa-4x" style="color: var(--success); margin-bottom: 15px;"></i>
                                    <h4 style="color: black;">Eye blink pattern recorded!</h4>
                                    
                                    <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 90%;">
                                        <h5 style="color: black;">Your pattern:</h5>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <span class="badge bg-primary p-2 mx-1" style="font-size: 1.1rem;">Code: ${newResult.code}</span>
                                        </div>
                                        <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">${newResult.display}</p>
                                    </div>
                                    
                                    <div class="d-flex mt-3">
                                        <button id="eyeblinkRetakeBtn2" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-redo me-2"></i>Retake
                                        </button>
                                        <button id="eyeblinkContinueBtn2" class="btn btn-primary">
                                            <i class="fas fa-arrow-right me-2"></i>Continue
                                        </button>
                                    </div>
                                </div>`;
                            
                            const retakeBtn2 = document.getElementById('eyeblinkRetakeBtn2');
                            const continueBtn2 = document.getElementById('eyeblinkContinueBtn2');
                            
                            retakeBtn2.addEventListener('click', () => {
                                retakeBtn.click();
                            });
                            
                            continueBtn2.addEventListener('click', () => {
                                resolve();
                            });
                        } else {
                            eyeblinkData.value = 'LB';
                            captureBox.innerHTML = `
                                <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                    <i class="fas fa-exclamation-triangle fa-4x" style="color: var(--warning); margin-bottom: 15px;"></i>
                                    <h4 style="color: black;">Using default pattern</h4>
                                    
                                    <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 90%;">
                                        <h5 style="color: black;">Default pattern:</h5>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <span class="badge bg-warning p-2 mx-1" style="font-size: 1.1rem;">Code: LB</span>
                                        </div>
                                        <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">Left Eye Both Eyes</p>
                                    </div>
                                    
                                    <button id="eyeblinkContinueBtn2" class="btn btn-primary mt-3">
                                        <i class="fas fa-arrow-right me-2"></i>Continue
                                    </button>
                                </div>`;
                            
                            document.getElementById('eyeblinkContinueBtn2').addEventListener('click', () => {
                                resolve();
                            });
                        }
                    });
                    
                    continueBtn.addEventListener('click', () => {
                        resolve();
                    });
                });
            } else {
                eyeblinkData.value = 'LB';
                captureBox.innerHTML = `
                    <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <i class="fas fa-exclamation-triangle fa-4x" style="color: var(--warning); margin-bottom: 15px;"></i>
                        <h4 style="color: black;">Using default pattern</h4>
                        
                        <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 90%;">
                            <h5 style="color: black;">Default pattern:</h5>
                            <div class="d-flex align-items-center justify-content-center">
                                <span class="badge bg-warning p-2 mx-1" style="font-size: 1.1rem;">Code: LB</span>
                            </div>
                            <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">Left Eye Both Eyes</p>
                        </div>
                        
                        <div class="d-flex mt-3">
                            <button id="eyeblinkRetakeBtn" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-redo me-2"></i>Try Again
                            </button>
                            <button id="eyeblinkContinueBtn" class="btn btn-primary">
                                <i class="fas fa-arrow-right me-2"></i>Continue with Default
                            </button>
                        </div>
                    </div>`;
                
                const retakeBtn = document.getElementById('eyeblinkRetakeBtn');
                const continueBtn = document.getElementById('eyeblinkContinueBtn');
                
                await new Promise(resolve => {
                    retakeBtn.addEventListener('click', async () => {
                        captureBox.innerHTML = `
                            <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                                <h4 class="mb-3" style="color: black;">Recording Eye Blink Pattern</h4>
                                <p style="color: black;">A camera window has opened. Please look at the camera and blink your eyes to record a pattern.</p>
                                <p style="color: #555;">The window will close automatically when recording is complete.</p>
                            </div>
                        `;
                        
                        const newResponse = await fetch('/record_biometric', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                biometric_type: 'eyeblink'
                            })
                        });
                        
                        const newResult = await newResponse.json();
                        
                        if (newResult.success) {
                            eyeblinkData.value = newResult.code;
                            captureBox.innerHTML = `
                                <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                    <i class="fas fa-check-circle fa-4x" style="color: var(--success); margin-bottom: 15px;"></i>
                                    <h4 style="color: black;">Eye blink pattern recorded!</h4>
                                    
                                    <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 90%;">
                                        <h5 style="color: black;">Your pattern:</h5>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <span class="badge bg-primary p-2 mx-1" style="font-size: 1.1rem;">Code: ${newResult.code}</span>
                                        </div>
                                        <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">${newResult.display}</p>
                                    </div>
                                    
                                    <div class="d-flex mt-3">
                                        <button id="eyeblinkRetakeBtn2" class="btn btn-outline-secondary me-2">
                                            <i class="fas fa-redo me-2"></i>Retake
                                        </button>
                                        <button id="eyeblinkContinueBtn2" class="btn btn-primary">
                                            <i class="fas fa-arrow-right me-2"></i>Continue
                                        </button>
                                    </div>
                                </div>`;
                            
                            const retakeBtn2 = document.getElementById('eyeblinkRetakeBtn2');
                            const continueBtn2 = document.getElementById('eyeblinkContinueBtn2');
                            
                            retakeBtn2.addEventListener('click', () => {
                                retakeBtn.click();
                            });
                            
                            continueBtn2.addEventListener('click', () => {
                                resolve();
                            });
                        } else {
                            eyeblinkData.value = 'LB';
                            captureBox.innerHTML = `
                                <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                    <i class="fas fa-exclamation-triangle fa-4x" style="color: var(--warning); margin-bottom: 15px;"></i>
                                    <h4 style="color: black;">Using default pattern</h4>
                                    
                                    <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 90%;">
                                        <h5 style="color: black;">Default pattern:</h5>
                                        <div class="d-flex align-items-center justify-content-center">
                                            <span class="badge bg-warning p-2 mx-1" style="font-size: 1.1rem;">Code: LB</span>
                                        </div>
                                        <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">Left Eye Both Eyes</p>
                                    </div>
                                    
                                    <button id="eyeblinkContinueBtn2" class="btn btn-primary mt-3">
                                        <i class="fas fa-arrow-right me-2"></i>Continue
                                    </button>
                                </div>`;
                            
                            document.getElementById('eyeblinkContinueBtn2').addEventListener('click', () => {
                                resolve();
                            });
                        }
                    });
                    
                    continueBtn.addEventListener('click', () => {
                        resolve();
                    });
                });
            }

            // Step 3: Neck Movement
            updateStep(2);
            currentStepInfo.textContent = 'Recording neck movement...';

            // Show recording in progress message
            captureBox.innerHTML = `
                <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                    <h4 class="mb-3" style="color: black;">Recording Neck Movement Pattern</h4>
                    <p style="color: black;">A camera window has opened. Please follow the instructions to record your neck movement pattern.</p>
                    <p style="color: #555;">Move your head in different directions (Up, Down, Left, Right) to create a sequence.</p>
                    <p style="color: #555;">The window will close automatically when recording is complete.</p>
                </div>
            `;

            // Start the neck movement recording - this will open the neckmov.py popup
            const neckResponse = await fetch('/record_biometric', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    biometric_type: 'neck_movement'
                })
            });

            const neckResult = await neckResponse.json();

            if (neckResult.success) {
                neckMovementData.value = neckResult.code;
                captureBox.innerHTML = `
                    <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <i class="fas fa-check-circle fa-4x" style="color: var(--success); margin-bottom: 15px;"></i>
                        <h4 style="color: black;">Neck Movement Pattern Recorded!</h4>
                        
                        <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 100%;">
                            <h5 style="color: black;">Your pattern:</h5>
                            <div class="d-flex align-items-center justify-content-center">
                                <span class="badge bg-primary p-2 mx-1" style="font-size: 1.1rem;">Code: ${neckResult.code}</span>
                            </div>
                            <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">${neckResult.display}</p>
                            <div class="d-flex mt-2 justify-content-center flex-wrap">
                                ${neckResult.code.split('').map(letter => {
                                    let icon, direction;
                                    switch(letter) {
                                        case 'U': icon = 'fa-arrow-up'; direction = 'Up'; break;
                                        case 'D': icon = 'fa-arrow-down'; direction = 'Down'; break;
                                        case 'L': icon = 'fa-arrow-left'; direction = 'Left'; break;
                                        case 'R': icon = 'fa-arrow-right'; direction = 'Right'; break;
                                        default: icon = 'fa-circle'; direction = 'Unknown';
                                    }
                                    return `<div class="mx-3 p-2 d-flex flex-column align-items-center">
                                        <i class="fas ${icon} fa-2x" style="color: var(--primary);"></i>
                                        <small class="mt-1">${direction}</small>
                                    </div>`;
                                }).join('')}
                            </div>
                        </div>
                        
                        <div class="d-flex mt-3">
                            <button id="neckRetakeBtn2" class="btn btn-outline-secondary me-3">
                                <i class="fas fa-redo me-2"></i>Record Again
                            </button>
                            <button id="neckContinueBtn2" class="btn btn-primary">
                                <i class="fas fa-arrow-right me-2"></i>Continue
                            </button>
                        </div>
                    </div>`;
            } else {
                neckMovementData.value = 'RLU';
                captureBox.innerHTML = `
                    <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <i class="fas fa-exclamation-triangle fa-4x" style="color: var(--warning); margin-bottom: 15px;"></i>
                        <h4 style="color: black;">Using default pattern</h4>
                        
                        <div class="mt-3 mb-4 p-3" style="border: 2px solid #ddd; border-radius: 8px; background-color: #f8f9fa; width: 100%;">
                            <h5 style="color: black;">Default pattern:</h5>
                            <div class="d-flex align-items-center justify-content-center">
                                <span class="badge bg-warning p-2 mx-1" style="font-size: 1.1rem;">Code: RLU</span>
                            </div>
                            <p class="mt-2" style="color: #333; font-weight: bold; font-size: 1.1rem;">Right Left Up</p>
                            <div class="d-flex mt-2 justify-content-center">
                                <div class="mx-3 p-2 d-flex flex-column align-items-center">
                                    <i class="fas fa-arrow-right fa-2x" style="color: var(--primary);"></i>
                                    <small class="mt-1">Right</small>
                                </div>
                                <div class="mx-3 p-2 d-flex flex-column align-items-center">
                                    <i class="fas fa-arrow-left fa-2x" style="color: var(--primary);"></i>
                                    <small class="mt-1">Left</small>
                                </div>
                                <div class="mx-3 p-2 d-flex flex-column align-items-center">
                                    <i class="fas fa-arrow-up fa-2x" style="color: var(--primary);"></i>
                                    <small class="mt-1">Up</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex mt-3">
                            <button id="neckRetakeBtn" class="btn btn-outline-secondary me-2">
                                <i class="fas fa-redo me-2"></i>Try Again
                            </button>
                            <button id="neckContinueBtn" class="btn btn-primary">
                                <i class="fas fa-arrow-right me-2"></i>Continue with Default
                            </button>
                        </div>
                    </div>`;
            }

            // Step 4: Voice
            updateStep(3);
            captureBox.innerHTML = `
                <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                    <h4 class="mb-3" style="color: black;">Voice Recognition Setup</h4>
                    <p style="color: black;">You will record the phrase:<br>
                        <span style="font-weight: bold; font-size: 1.2rem; color: #007bff; background-color: #f8f9fa; padding: 8px; border-radius: 4px; display: inline-block; margin-top: 10px;">
                            "I let the positive overrun the negative"
                        </span>
                    </p>
                    <p style="color: #555;">You'll need to record this phrase 4 times</p>
                    <button id="startVoiceRecordingBtn" class="btn btn-primary mx-auto mt-3" style="width: 200px;">
                        <i class="fas fa-microphone me-2"></i>Start Recording
                    </button>
                </div>
            `;

            // Wait for the voice step completion
            await new Promise(resolve => {
                // Store the resolve function
                const continueToNextStep = resolve;
                
                document.getElementById('startVoiceRecordingBtn').addEventListener('click', async function() {
                    // Update UI for recording setup
                    captureBox.innerHTML = `
                        <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                            <h4 class="mb-3" style="color: black;">Initializing Microphone...</h4>
                            <p style="color: #555;">Please wait while we prepare the recording system</p>
                        </div>
                    `;

                    try {
                        // Initialize recording
                        const setupResponse = await fetch('/record_biometric', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ biometric_type: 'voice' })
                        });
                        
                        const setupResult = await setupResponse.json();
                        console.log("Voice recording setup:", setupResult);
                        
                        if (!setupResult.ready_to_record) {
                            throw new Error(setupResult.error || "Failed to initialize recording");
                        }
                        
                        // For each of the 4 samples
                        for (let sampleNumber = 1; sampleNumber <= 4; sampleNumber++) {
                            // Show sample recording UI
                            captureBox.innerHTML = `
                                <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%;">
                                    <h4 class="mb-3" style="color: black;">Recording Sample ${sampleNumber}/4</h4>
                                    
                                    <div id="instructionBox" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 8px; border-left: 5px solid #007bff;">
                                        <p style="font-weight: bold; font-size: 1.2rem; color: #007bff; margin-bottom: 5px;">Please say clearly:</p>
                                        <p style="font-size: 1.1rem; font-weight: bold;">"I let the positive overrun the negative"</p>
                                    </div>
                                    
                                    <div id="countdownBox" style="margin: 20px auto; width: 100px; height: 100px; border-radius: 50%; background-color: #f8f9fa; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; color: #007bff;">
                                        3
                                    </div>
                                    
                                    <div id="recordingIndicator" style="display: none; margin: 20px auto;">
                                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 10px;">
                                            <div class="recording-dot" style="width: 24px; height: 24px; background-color: red; border-radius: 50%; margin-right: 10px; animation: pulse 1s infinite;"></div>
                                            <span style="font-weight: bold; font-size: 1.2rem;">Recording...</span>
                                        </div>
                                        <div id="progressBar" style="width: 100%; height: 10px; background-color: #f0f0f0; border-radius: 5px; overflow: hidden;">
                                            <div id="progressFill" style="width: 0%; height: 100%; background-color: #007bff; transition: width 0.1s linear;"></div>
                                        </div>
                                        <p id="timeRemaining" style="margin-top: 5px; font-size: 0.9rem; color: #555;">0/5 seconds</p>
                                    </div>
                                    
                                    <div id="processingIndicator" style="display: none; margin: 20px auto;">
                                        <div class="spinner-border text-primary" role="status"></div>
                                        <p style="margin-top: 10px;">Processing recording...</p>
                                    </div>
                                    
                                    <div id="statusMessage" class="mt-3" style="min-height: 50px;"></div>
                                </div>
                            `;
                            
                            // Apply pulse animation
                            const style = document.createElement('style');
                            style.textContent = `
                                @keyframes pulse {
                                    0% { opacity: 1; }
                                    50% { opacity: 0.5; }
                                    100% { opacity: 1; }
                                }
                            `;
                            document.head.appendChild(style);
                            
                            // Countdown
                            const countdownBox = document.getElementById('countdownBox');
                            const instructionBox = document.getElementById('instructionBox');
                            const recordingIndicator = document.getElementById('recordingIndicator');
                            
                            // Run countdown
                            for (let i = 3; i > 0; i--) {
                                countdownBox.textContent = i;
                                await new Promise(resolve => setTimeout(resolve, 1000));
                            }
                            
                            // Show "GO" before starting
                            countdownBox.textContent = "GO!";
                            countdownBox.style.backgroundColor = "#28a745";
                            countdownBox.style.color = "white";
                            await new Promise(resolve => setTimeout(resolve, 500));
                            
                            // Hide countdown, show recording
                            countdownBox.style.display = "none";
                            recordingIndicator.style.display = "block";
                            
                            // Update progress bar during recording
                            const progressFill = document.getElementById('progressFill');
                            const timeRemaining = document.getElementById('timeRemaining');
                            
                            // Start actual recording in background
                            const recordPromise = fetch('/record_voice_sample', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    sample_number: sampleNumber,
                                    user_dir: setupResult.user_dir
                                })
                            });
                            
                            // Show progress while recording happens
                            for (let i = 0; i <= 50; i++) {
                                const percent = i * 2;
                                progressFill.style.width = `${percent}%`;
                                timeRemaining.textContent = `${Math.floor(i/10)}/5 seconds`;
                                await new Promise(resolve => setTimeout(resolve, 100));
                            }
                            
                            // Hide recording indicator, show processing
                            recordingIndicator.style.display = "none";
                            document.getElementById('processingIndicator').style.display = "block";
                            
                            // Wait for the recording to finish processing
                            const recordResult = await (await recordPromise).json();
                            console.log(`Sample ${sampleNumber} result:`, recordResult);
                            
                            // Show status
                            const statusMessage = document.getElementById('statusMessage');
                            if (recordResult.success) {
                                statusMessage.innerHTML = `
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>Recording ${sampleNumber} completed successfully!
                                    </div>
                                `;
                            } else {
                                statusMessage.innerHTML = `
                                    <div class="alert alert-danger">
                                        <i class="fas fa-times-circle me-2"></i>Error: ${recordResult.error || "Recording failed"}
                                        <p>We'll try again.</p>
                                    </div>
                                `;
                                sampleNumber--; // Try this sample again
                            }
                            
                            // Wait briefly before next sample
                            await new Promise(resolve => setTimeout(resolve, 1500));
                        }
                        
                        // All samples complete - show model training
                        captureBox.innerHTML = `
                            <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                                <h4 class="mb-3" style="color: black;">Training Voice Model</h4>
                                <p style="color: #555;">Please wait while we process your voice recordings</p>
                                <div class="progress mt-3" style="height: 10px;">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                                </div>
                            </div>
                        `;
                        
                        // Get the final model path from the last recording
                        const modelPath = setupResult.code;
                        voiceData.value = modelPath;
                        
                        // Wait for visual effect
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        
                        // Show success UI
                        captureBox.innerHTML = `
                            <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #28a745; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                                    <i class="fas fa-check fa-3x" style="color: white;"></i>
                                </div>
                                <h4 style="color: black;">Voice Model Created Successfully!</h4>
                                <p style="color: #555; max-width: 80%; margin: 15px auto;">Your unique voice pattern has been saved and can now be used for verification.</p>
                                <button id="voiceContinueBtn" class="btn btn-primary btn-lg mt-3">
                                    <i class="fas fa-arrow-right me-2"></i>Continue
                                </button>
                            </div>`;
                        
                        // Continue to next step when button clicked
                        document.getElementById('voiceContinueBtn').addEventListener('click', function() {
                            console.log("Voice step complete, continuing to next step");
                            continueToNextStep();
                        });
                        
                    } catch (error) {
                        console.error('Error during voice recording:', error);
                        captureBox.innerHTML = `
                            <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                                <div style="width: 80px; height: 80px; border-radius: 50%; background-color: #dc3545; display: flex; justify-content: center; align-items: center; margin-bottom: 20px;">
                                    <i class="fas fa-times fa-3x" style="color: white;"></i>
                                </div>
                                <h4 style="color: black;">Voice Recording Failed</h4>
                                <p style="color: #555; max-width: 80%; margin: 15px auto;">${error.message || "An unexpected error occurred"}</p>
                                <div class="d-flex mt-3">
                                    <button id="voiceErrorRetryBtn" class="btn btn-primary btn-lg me-2">
                                        <i class="fas fa-redo me-2"></i>Try Again
                                    </button>
                                    <button id="voiceErrorSkipBtn" class="btn btn-outline-secondary btn-lg">
                                        <i class="fas fa-forward me-2"></i>Skip
                                    </button>
                                </div>
                            </div>`;
                            
                        document.getElementById('voiceErrorRetryBtn').addEventListener('click', function() {
                            // Restart voice recording process
                            document.getElementById('startVoiceRecordingBtn').click();
                        });
                        
                        document.getElementById('voiceErrorSkipBtn').addEventListener('click', function() {
                            console.log("Skipping voice step");
                            continueToNextStep();
                        });
                    }
                });
            });

            // Step 5: Face Detection
            updateStep(4);
            currentStepInfo.textContent = 'Recording face...';
            captureBox.innerHTML = `
                <div style="text-align: center; padding: 20px; background-color: white; color: black; border-radius: 8px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center;">
                    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem; margin: 0 auto;" role="status"></div>
                    <h4 class="mb-3" style="color: black;">Recording Face Recognition</h4>
                    <p style="color: black;">A camera window is opening. Please look at the camera and follow the on-screen directions.</p>
                    <p style="color: #555;">the system will train the face recognition model. Process takes 3-4 minutes.</p>
                    <div class="progress mt-3" style="height: 20px;">
                        <div id="faceProgressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 5%"></div>
                    </div>
                    <p id="faceProgressStatus" class="mt-2">Starting face enrollment...</p>
                </div>
            `;

            // Set up a variable to track progress stages
            let faceCurrentStage = 'starting';
            let stageStartTime = Date.now();

            // Start the face enrollment process
            const faceResponse = fetch('/record_biometric', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    biometric_type: 'face_detection'
                })
            });

            // Update progress animation while waiting for response
            let progressPercent = 5;
            const progressInterval = setInterval(() => {
                const currentTime = Date.now();
                const timeElapsed = (currentTime - stageStartTime) / 1000; // seconds
                
                // Change stages based on elapsed time
                if (faceCurrentStage === 'starting' && timeElapsed > 3) {
                    faceCurrentStage = 'capturing';
                    stageStartTime = currentTime;
                    document.getElementById('faceProgressStatus').textContent = 'Capturing face images...';
                } else if (faceCurrentStage === 'capturing' && timeElapsed > 60) {
                    faceCurrentStage = 'processing';
                    stageStartTime = currentTime;
                    document.getElementById('faceProgressStatus').textContent = 'Processing face data...';
                } else if (faceCurrentStage === 'processing' && timeElapsed > 30) {
                    faceCurrentStage = 'training';
                    stageStartTime = currentTime;
                    document.getElementById('faceProgressStatus').textContent = 'Training face recognition model...';
                }
                
                // Update progress percentage based on current stage
                if (faceCurrentStage === 'starting') {
                    progressPercent = Math.min(5 + (timeElapsed * 2), 10);
                } else if (faceCurrentStage === 'capturing') {
                    progressPercent = Math.min(10 + (timeElapsed / 60 * 50), 60);
                } else if (faceCurrentStage === 'processing') {
                    progressPercent = Math.min(60 + (timeElapsed / 30 * 20), 80);
                } else if (faceCurrentStage === 'training') {
                    progressPercent = Math.min(80 + (timeElapsed / 60 * 15), 95);
                }
                
                document.getElementById('faceProgressBar').style.width = `${progressPercent}%`;
            }, 1000);

            // Wait for the response
            faceResponse.then(response => response.json())
            .then(faceResult => {
                clearInterval(progressInterval);

                if (faceResult.success) {
                    document.getElementById('faceProgressBar').style.width = '100%';
                    document.getElementById('faceProgressStatus').textContent = 'Face recognition setup complete!';
                    
                    faceDetectionData.value = faceResult.code;
                    captureBox.innerHTML = `
                        <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <i class="fas fa-check-circle fa-4x" style="color: var(--success); margin-bottom: 15px;"></i>
                            <h4 style="color: black;">Face recorded successfully!</h4>
                            <p style="color: #555;">Your face recognition profile has been created and can now be used for verification.</p>
                        </div>`;
                } else {
                    faceDetectionData.value = 'default_face';
                    captureBox.innerHTML = `
                        <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <i class="fas fa-exclamation-triangle fa-4x" style="color: var(--warning); margin-bottom: 15px;"></i>
                            <h4 style="color: black;">Using default face pattern</h4>
                            <p style="color: #555;">We couldn't record your face: ${faceResult.error || 'Unknown error'}</p>
                            <button id="retryFaceBtn" class="btn btn-primary mt-3">Try Again</button>
                        </div>`;
                        
                    // Set up retry button
                    document.getElementById('retryFaceBtn').addEventListener('click', async () => {
                        // Reset this step
                        updateStep(4);
                        currentStepInfo.textContent = 'Recording face...';
                        // Restart the face recording process
                        // Same code as above...
                    });
                }
                
                // All steps completed
                progressInfo.innerHTML = '<i class="fas fa-check-circle text-success me-2"></i>All biometrics captured successfully!';
                saveBtn.disabled = false;
                
            }).catch(error => {
                clearInterval(progressInterval);
                console.error('Error during face enrollment:', error);
                
                faceDetectionData.value = 'default_face';
                captureBox.innerHTML = `
                    <div style="text-align: center; background-color: white; color: black; border-radius: 8px; padding: 20px; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <i class="fas fa-times-circle fa-4x" style="color: var(--danger); margin-bottom: 15px;"></i>
                        <h4 style="color: black;">Face Enrollment Failed</h4>
                        <p style="color: #555;">An error occurred: ${error.message || 'Unknown error'}</p>
                        <button id="retryFaceBtn" class="btn btn-primary mt-3">Try Again</button>
                    </div>`;
                    
                // Set up retry button
                document.getElementById('retryFaceBtn').addEventListener('click', async () => {
                    // Reset and try again
                    // (Similar code as above)
                });
            });
        } catch (error) {
            console.error('Error recording biometrics:', error);
            progressInfo.innerHTML = '<i class="fas fa-exclamation-circle text-danger me-2"></i>Error recording biometrics. Please try again.';
            captureBtn.disabled = false;
        }
    });
});
</script>
{% endblock %}
